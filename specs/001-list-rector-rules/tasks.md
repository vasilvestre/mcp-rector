# Tasks: List Available Rector Rules

**Input**: Design documents from `/specs/001-list-rector-rules/`  
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/

**Tests**: No test tasks included (not explicitly requested in specification)

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions

Single project structure at repository root:
- **Source**: `src/`
- **Build output**: `build/` (generated by TypeScript compiler)

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and MCP server structure

- [X] T001 Verify TypeScript build configuration in tsconfig.json
- [X] T002 [P] Add test script to package.json for node:test runner
- [X] T003 [P] Create tests/ directory structure with unit/ and integration/ subdirectories

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented

**âš ï¸ CRITICAL**: No user story work can begin until this phase is complete

- [X] T004 Create Rule and RuleSet type definitions in src/models/rule.ts
- [X] T005 Create CacheState interface and status types in src/models/cache.ts
- [X] T006 [P] Implement HTTP fetcher for GitHub markdown in src/services/rector-fetcher.ts
- [X] T007 [P] Implement markdown parser for Rector rules in src/services/rule-parser.ts
- [X] T008 Implement RectorCache class with singleton pattern in src/models/cache.ts
- [X] T009 [P] Implement rule validation logic (FR-014) in src/services/rule-parser.ts
- [X] T010 [P] Implement RuleSet derivation logic in src/services/rule-parser.ts
- [X] T011 [P] Implement tag extraction for search in src/services/rule-parser.ts

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Browse All Available Rector Rules (Priority: P1) ðŸŽ¯ MVP

**Goal**: Users can retrieve a complete list of all Rector rules with metadata (name, description, rule set)

**Independent Test**: Call `list-rector-rules` MCP tool and verify ~382 rules are returned with complete metadata

### Implementation for User Story 1

- [X] T012 [US1] Create list-rules tool handler in src/tools/list-rules.ts
- [X] T013 [US1] Define Zod input schema (empty object) for list-rules tool
- [X] T014 [US1] Define Zod output schema for list-rules tool matching contracts/list-rules.json
- [X] T015 [US1] Implement list-rules handler to fetch all rules from cache
- [X] T016 [US1] Implement list-rules handler to return ruleSets derived from rules
- [X] T017 [US1] Add cacheStatus and lastUpdated metadata to list-rules response
- [X] T018 [US1] Register list-rules tool in src/index.ts with server.registerTool()
- [X] T019 [US1] Add error handling for cache load failures in list-rules tool
- [X] T020 [US1] Test list-rules tool manually via MCP Inspector or stdio

**Checkpoint**: At this point, User Story 1 should be fully functional - users can list all Rector rules

---

## Phase 4: User Story 2 - Filter Rules by Category or Rule Set (Priority: P2)

**Goal**: Users can filter rules by specific rule set (e.g., "php80", "code-quality") to narrow down results

**Independent Test**: Call `filter-rector-rules` with ruleSet="php80" and verify only PHP 8.0 rules are returned

### Implementation for User Story 2

- [X] T021 [US2] Create filter-rules tool handler in src/tools/filter-rules.ts
- [X] T022 [US2] Define Zod input schema (ruleSet: string) for filter-rules tool
- [X] T023 [US2] Define Zod output schema for filter-rules tool matching contracts/filter-rules.json
- [X] T024 [US2] Implement case-insensitive ruleSet matching in src/services/rule-filter.ts
- [X] T025 [US2] Implement filter logic to extract rules matching ruleSet in src/services/rule-filter.ts
- [X] T026 [US2] Implement RuleSet metadata extraction for filtered results in src/services/rule-filter.ts
- [X] T027 [US2] Implement filter-rules handler using rule-filter service
- [X] T028 [US2] Add matchedCount to filter-rules response
- [X] T029 [US2] Register filter-rules tool in src/index.ts with server.registerTool()
- [X] T030 [US2] Add error handling for invalid ruleSet names in filter-rules tool
- [X] T031 [US2] Test filter-rules tool with various rule sets (php80, CodeQuality, type-declaration)

**Checkpoint**: At this point, User Stories 1 AND 2 should both work independently

---

## Phase 5: User Story 3 - Search Rules by Keyword (Priority: P3)

**Goal**: Users can search rules by keyword (e.g., "attribute", "array") with optional rule set filter

**Independent Test**: Call `search-rector-rules` with query="attribute" and verify matching rules are returned with relevance indicators

### Implementation for User Story 3

- [X] T032 [US3] Create search-rules tool handler in src/tools/search-rules.ts
- [X] T033 [US3] Define Zod input schema (query: string, ruleSet?: string) for search-rules tool
- [X] T034 [US3] Define Zod output schema for search-rules tool matching contracts/search-rules.json
- [X] T035 [US3] Implement case-insensitive keyword matching against rule names in src/services/rule-filter.ts
- [X] T036 [US3] Implement case-insensitive keyword matching against descriptions in src/services/rule-filter.ts
- [X] T037 [US3] Implement case-insensitive keyword matching against tags in src/services/rule-filter.ts
- [X] T038 [US3] Implement relevance scoring (name match > description match > tag match) in src/services/rule-filter.ts
- [X] T039 [US3] Implement optional ruleSet filter for search results in src/services/rule-filter.ts
- [X] T040 [US3] Implement search-rules handler using rule-filter service
- [X] T041 [US3] Add matchedCount and relevance field to search-rules response
- [X] T042 [US3] Register search-rules tool in src/index.ts with server.registerTool()
- [X] T043 [US3] Add error handling for empty query strings in search-rules tool
- [X] T044 [US3] Test search-rules tool with various queries (attribute, union type, array)
- [X] T045 [US3] Test search-rules tool with combined query + ruleSet filter

**Checkpoint**: All user stories should now be independently functional

---

## Phase 6: Polish & Cross-Cutting Concerns

**Purpose**: Improvements that affect multiple user stories

- [ ] T046 [P] Add JSDoc comments to all public functions and classes
- [ ] T047 [P] Verify all MCP tool responses follow structured content format
- [ ] T048 Run npm run build and verify TypeScript compilation succeeds
- [ ] T049 Run npm run lint (if configured) and fix any linting errors
- [ ] T050 [P] Verify quickstart.md instructions work end-to-end
- [ ] T051 [P] Add error logging for cache load failures using console.error
- [ ] T052 [P] Add performance logging for initial fetch duration
- [ ] T053 Verify all tools handle network errors gracefully per clarification #4
- [ ] T054 Verify cache persists across tool calls but clears on server restart per clarification #3
- [ ] T055 Test all three tools via Claude Desktop MCP client configuration

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories
- **User Stories (Phase 3-5)**: All depend on Foundational phase completion
  - User stories can then proceed in parallel (if staffed)
  - Or sequentially in priority order (P1 â†’ P2 â†’ P3)
- **Polish (Phase 6)**: Depends on all user stories being complete

### User Story Dependencies

- **User Story 1 (P1)**: Can start after Foundational (Phase 2) - No dependencies on other stories
- **User Story 2 (P2)**: Can start after Foundational (Phase 2) - Independent of US1 (reuses cache)
- **User Story 3 (P3)**: Can start after Foundational (Phase 2) - Independent of US1/US2 (reuses cache + filter service)

### Within Each User Story

#### User Story 1
1. Tool handler creation (T012)
2. Schema definitions (T013, T014) - can be parallel with T012
3. Handler implementation (T015-T017) - sequential, depends on schemas
4. Tool registration (T018) - depends on handler complete
5. Error handling (T019) - depends on handler complete
6. Manual testing (T020) - depends on registration complete

#### User Story 2
1. Tool handler creation (T021)
2. Schema definitions (T022, T023) - can be parallel with T021
3. Filter service implementation (T024-T026) - sequential within service file
4. Handler implementation (T027, T028) - depends on filter service
5. Tool registration (T029) - depends on handler complete
6. Error handling (T030) - depends on handler complete
7. Manual testing (T031) - depends on registration complete

#### User Story 3
1. Tool handler creation (T032)
2. Schema definitions (T033, T034) - can be parallel with T032
3. Search logic implementation (T035-T039) - sequential within service file
4. Handler implementation (T040, T041) - depends on search logic
5. Tool registration (T042) - depends on handler complete
6. Error handling (T043) - depends on handler complete
7. Manual testing (T044, T045) - depends on registration complete

### Parallel Opportunities

- **Phase 1**: T002 and T003 can run in parallel
- **Phase 2**: T006, T007, T009, T010, T011 can all run in parallel (different service files)
- **Phase 3 (US1)**: No parallel opportunities within story (sequential workflow)
- **Phase 4 (US2)**: No parallel opportunities within story (sequential workflow)
- **Phase 5 (US3)**: No parallel opportunities within story (sequential workflow)
- **Phase 6**: T046, T047, T050, T051, T052, T053 can all run in parallel (different concerns)
- **Across User Stories**: US2 and US3 can be implemented in parallel after US1 completes (if team capacity allows)

---

## Parallel Example: Foundational Phase

```bash
# Launch foundational services together (Phase 2):
Task: "Implement HTTP fetcher for GitHub markdown in src/services/rector-fetcher.ts"
Task: "Implement markdown parser for Rector rules in src/services/rule-parser.ts"
Task: "Implement rule validation logic (FR-014) in src/services/rule-parser.ts"
Task: "Implement RuleSet derivation logic in src/services/rule-parser.ts"
Task: "Implement tag extraction for search in src/services/rule-parser.ts"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational (CRITICAL - blocks all stories)
3. Complete Phase 3: User Story 1
4. **STOP and VALIDATE**: Test `list-rector-rules` independently via MCP Inspector
5. Deploy/demo if ready

**MVP Deliverable**: Users can browse all ~382 Rector rules with names, descriptions, and rule sets

### Incremental Delivery

1. Complete Setup + Foundational â†’ Foundation ready
2. Add User Story 1 â†’ Test `list-rector-rules` â†’ Deploy/Demo (MVP!)
3. Add User Story 2 â†’ Test `filter-rector-rules` â†’ Deploy/Demo
4. Add User Story 3 â†’ Test `search-rector-rules` â†’ Deploy/Demo
5. Each story adds value without breaking previous stories

### Parallel Team Strategy

With multiple developers:

1. Team completes Setup + Foundational together (T001-T011)
2. Once Foundational is done:
   - Developer A: User Story 1 (T012-T020)
   - Developer B: User Story 2 (T021-T031) - can start after US1 handler pattern established
   - Developer C: User Story 3 (T032-T045) - can start after filter service exists
3. Stories complete and integrate independently

---

## Technology Stack Reference

From research.md:

- **Testing**: Node.js built-in `node:test` runner
- **HTTP**: Native `fetch` API (Node 18+)
- **Data Source**: `https://raw.githubusercontent.com/rectorphp/rector/main/docs/rector_rules_overview.md`
- **MCP Pattern**: `server.registerTool()` with Zod schemas
- **Caching**: TypeScript `Map` singleton class (RectorCache)

---

## File Structure (Expected after implementation)

```
src/
â”œâ”€â”€ index.ts                      # MCP server entry + tool registration
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ rule.ts                   # Rule, RuleSet, CacheState interfaces
â”‚   â””â”€â”€ cache.ts                  # RectorCache singleton class
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ rector-fetcher.ts         # GitHub markdown fetch logic
â”‚   â”œâ”€â”€ rule-parser.ts            # Markdown parsing + validation + derivation
â”‚   â””â”€â”€ rule-filter.ts            # Filter and search logic
â””â”€â”€ tools/
    â”œâ”€â”€ list-rules.ts             # list-rector-rules tool handler
    â”œâ”€â”€ filter-rules.ts           # filter-rector-rules tool handler
    â””â”€â”€ search-rules.ts           # search-rector-rules tool handler

tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ rule-parser.test.ts       # (Future: if tests added)
â”‚   â””â”€â”€ rule-filter.test.ts       # (Future: if tests added)
â””â”€â”€ integration/
    â””â”€â”€ tools.test.ts             # (Future: if tests added)
```

---

## Success Criteria Validation

After completion, verify these measurable outcomes from spec.md:

- **SC-001**: `list-rector-rules` returns results in <3 seconds (initial fetch)
- **SC-002**: Users can find specific rules within 1 minute using search/filter
- **SC-003**: All ~382 rules are returned with complete metadata
- **SC-004**: No missing rules from official Rector rule sets
- **SC-005**: `filter-rector-rules` returns results in <1 second
- **SC-006**: `search-rector-rules` returns relevant matches (manual validation)

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story should be independently completable and testable
- Commit after each logical task group (e.g., after completing a tool handler)
- Stop at any checkpoint to validate story independently
- No pagination required (per clarification #2) - return all results
- Cache cleared on server restart (per clarification #3)
- Skip rules with incomplete metadata (per clarification #5)
- Return stale cache on network errors if available (per clarification #4)

---

## Total Task Count: 55 tasks

- **Phase 1 (Setup)**: 3 tasks
- **Phase 2 (Foundational)**: 8 tasks
- **Phase 3 (US1 - Browse)**: 9 tasks
- **Phase 4 (US2 - Filter)**: 11 tasks
- **Phase 5 (US3 - Search)**: 14 tasks
- **Phase 6 (Polish)**: 10 tasks

**Parallel Opportunities**: 15 tasks marked [P] across all phases

**Independent Test Criteria**:
- US1: Call `list-rector-rules`, verify ~382 rules returned
- US2: Call `filter-rector-rules` with "php80", verify filtered results
- US3: Call `search-rector-rules` with "attribute", verify search matches

**Suggested MVP Scope**: Phase 1 + Phase 2 + Phase 3 (User Story 1 only) = 20 tasks
